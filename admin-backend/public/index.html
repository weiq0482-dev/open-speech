<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenSpeech å®¢æœç®¡ç†åå°</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; height: 100vh; display: flex; overflow: hidden; }

    /* å·¦ä¾§ä¼šè¯åˆ—è¡¨ */
    .sidebar { width: 320px; background: #fff; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; flex-shrink: 0; }
    .sidebar-header { padding: 16px 20px; border-bottom: 1px solid #e5e7eb; }
    .sidebar-header h1 { font-size: 18px; font-weight: 700; color: #1a1a1a; }
    .sidebar-header p { font-size: 12px; color: #999; margin-top: 4px; }
    .thread-list { flex: 1; overflow-y: auto; }
    .thread-item { padding: 14px 20px; border-bottom: 1px solid #f3f4f6; cursor: pointer; transition: background 0.15s; display: flex; align-items: center; gap: 12px; }
    .thread-item:hover { background: #f9fafb; }
    .thread-item.active { background: #eff6ff; border-right: 3px solid #3b82f6; }
    .thread-avatar { width: 40px; height: 40px; border-radius: 50%; background: #e0e7ff; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #4f46e5; flex-shrink: 0; }
    .thread-info { flex: 1; min-width: 0; }
    .thread-name { font-size: 14px; font-weight: 600; color: #1a1a1a; display: flex; align-items: center; gap: 8px; }
    .thread-preview { font-size: 12px; color: #999; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .thread-time { font-size: 11px; color: #bbb; flex-shrink: 0; }
    .unread-badge { background: #ef4444; color: #fff; font-size: 10px; border-radius: 10px; padding: 1px 6px; min-width: 18px; text-align: center; }
    .thread-empty { padding: 40px 20px; text-align: center; color: #999; font-size: 14px; }
    .status-bar { padding: 6px 20px; background: #f0fdf4; border-bottom: 1px solid #bbf7d0; font-size: 11px; color: #16a34a; display: flex; align-items: center; gap: 6px; }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #22c55e; animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

    /* å³ä¾§èŠå¤©åŒº */
    .chat-area { flex: 1; display: flex; flex-direction: column; background: #f7f8fa; }
    .chat-header { padding: 14px 24px; background: #fff; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; }
    .chat-header h2 { font-size: 15px; font-weight: 600; color: #1a1a1a; }
    .chat-header p { font-size: 12px; color: #999; margin-top: 2px; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 20px 24px; display: flex; flex-direction: column; gap: 10px; }

    .msg-row { display: flex; }
    .msg-row.user { justify-content: flex-start; }
    .msg-row.admin { justify-content: flex-end; }
    .msg-bubble { max-width: 70%; padding: 10px 14px; border-radius: 18px; font-size: 14px; line-height: 1.5; word-break: break-word; white-space: pre-wrap; }
    .msg-row.user .msg-bubble { background: #fff; color: #1a1a1a; border: 1px solid #e5e7eb; border-bottom-left-radius: 4px; }
    .msg-row.admin .msg-bubble { background: #3b82f6; color: #fff; border-bottom-right-radius: 4px; }
    .msg-bubble img { max-width: 240px; max-height: 240px; border-radius: 8px; margin-top: 4px; cursor: pointer; }
    .msg-time { font-size: 10px; margin-top: 4px; opacity: 0.6; }
    .msg-row.admin .msg-time { text-align: right; }

    /* è¾“å…¥åŒº */
    .chat-input-area { padding: 12px 24px; background: #fff; border-top: 1px solid #e5e7eb; flex-shrink: 0; }
    .input-toolbar { display: flex; gap: 8px; margin-bottom: 8px; }
    .input-toolbar button { background: none; border: 1px solid #e0e3e8; border-radius: 8px; padding: 6px 12px; font-size: 13px; cursor: pointer; color: #666; transition: all 0.15s; display: flex; align-items: center; gap: 4px; }
    .input-toolbar button:hover { background: #f3f4f6; border-color: #3b82f6; color: #3b82f6; }
    .input-row { display: flex; gap: 10px; align-items: flex-end; }
    .input-row textarea { flex: 1; padding: 10px 16px; border: 1px solid #e0e3e8; border-radius: 16px; font-size: 14px; outline: none; transition: border 0.2s; resize: none; min-height: 42px; max-height: 120px; font-family: inherit; line-height: 1.4; }
    .input-row textarea:focus { border-color: #3b82f6; }
    .input-row button.send-btn { padding: 10px 24px; background: #3b82f6; color: #fff; border: none; border-radius: 16px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background 0.2s; white-space: nowrap; height: 42px; }
    .input-row button.send-btn:hover { background: #2563eb; }
    .input-row button.send-btn:disabled { background: #d1d5db; cursor: not-allowed; }

    /* å›¾ç‰‡é¢„è§ˆ */
    .preview-area { margin-bottom: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
    .preview-item { position: relative; display: inline-block; }
    .preview-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #e0e3e8; }
    .preview-item .remove-btn { position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; background: #ef4444; color: #fff; border: none; border-radius: 50%; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1; }

    /* æ— é€‰ä¸­ä¼šè¯ */
    .no-chat { flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 12px; color: #ccc; }
    .no-chat svg { width: 64px; height: 64px; opacity: 0.3; }
    .no-chat p { font-size: 15px; }
    .hidden { display: none !important; }

    /* æ ‡ç­¾é¡µ */
    .tab-bar { display: flex; border-bottom: 1px solid #e5e7eb; }
    .tab-btn { flex: 1; padding: 10px 0; border: none; background: none; font-size: 13px; font-weight: 500; color: #999; cursor: pointer; transition: all 0.2s; border-bottom: 2px solid transparent; }
    .tab-btn:hover { color: #333; background: #f9fafb; }
    .tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; }

    /* å…‘æ¢ç åˆ—è¡¨é¡¹ */
    .coupon-item { padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 8px; background: #fff; font-size: 12px; }
    .coupon-item .code { font-family: 'Courier New', monospace; font-size: 14px; font-weight: 700; color: #1a1a1a; letter-spacing: 1px; }
    .coupon-item .meta { color: #999; margin-top: 4px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .coupon-item .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; }
    .coupon-item .badge.unused { background: #dcfce7; color: #16a34a; }
    .coupon-item .badge.used { background: #fee2e2; color: #dc2626; }
    .coupon-item .badge.trial { background: #dbeafe; color: #2563eb; }
    .coupon-item .badge.monthly { background: #fef3c7; color: #d97706; }
    .coupon-item .badge.quarterly { background: #ede9fe; color: #7c3aed; }
    .coupon-item .copy-btn { padding: 2px 8px; border: 1px solid #e0e3e8; border-radius: 4px; font-size: 10px; cursor: pointer; background: #fff; color: #666; }
    .coupon-item .copy-btn:hover { background: #f3f4f6; }

    /* å›¾ç‰‡æŸ¥çœ‹å¤§å›¾ */
    .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .lightbox img { max-width: 90vw; max-height: 90vh; border-radius: 8px; }
  </style>
</head>
<body>
  <!-- å·¦ä¾§ -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h1>ğŸ§ ç®¡ç†åå°</h1>
      <p>OpenSpeech ç®¡ç†ç³»ç»Ÿ</p>
    </div>
    <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchTab('chat')">ğŸ’¬ å®¢æœ</button>
      <button class="tab-btn" onclick="switchTab('coupon')">ğŸ« å…‘æ¢ç </button>
      <button class="tab-btn" onclick="switchTab('settings')">âš™ï¸ è®¾ç½®</button>
    </div>
    <!-- å®¢æœæ ‡ç­¾å†…å®¹ -->
    <div id="tabChat">
      <div class="status-bar">
        <span class="status-dot"></span>
        <span>å·²è¿æ¥ Â· å®æ—¶åŒæ­¥ä¸­</span>
        <span id="totalUnread" style="margin-left:auto;font-weight:600;"></span>
      </div>
      <div class="thread-list" id="threadList">
        <div class="thread-empty">æš‚æ— ä¼šè¯</div>
      </div>
    </div>
    <!-- å…‘æ¢ç æ ‡ç­¾å†…å®¹ -->
    <div id="tabCoupon" class="hidden">
      <div style="padding:16px;">
        <h3 style="font-size:14px;font-weight:600;margin-bottom:12px;">ç”Ÿæˆå…‘æ¢ç </h3>
        <div style="display:flex;flex-direction:column;gap:10px;">
          <label style="font-size:12px;color:#666;">å¥—é¤ç±»å‹</label>
          <select id="couponPlan" style="padding:8px 12px;border:1px solid #e0e3e8;border-radius:8px;font-size:13px;outline:none;">
            <option value="trial">ä½“éªŒå¡ï¼ˆ7å¤© Â· 50æ¬¡å¯¹è¯ Â· 10æ¬¡ç”Ÿå›¾ï¼‰</option>
            <option value="monthly">æœˆå¡ï¼ˆ30å¤© Â· 500æ¬¡å¯¹è¯ Â· 50æ¬¡ç”Ÿå›¾ï¼‰</option>
            <option value="quarterly">å­£å¡ï¼ˆ90å¤© Â· 2000æ¬¡å¯¹è¯ Â· 200æ¬¡ç”Ÿå›¾ï¼‰</option>
          </select>
          <label style="font-size:12px;color:#666;">æ•°é‡</label>
          <input id="couponCount" type="number" value="5" min="1" max="50" style="padding:8px 12px;border:1px solid #e0e3e8;border-radius:8px;font-size:13px;outline:none;width:80px;" />
          <button onclick="generateCoupons()" style="padding:10px 20px;background:#3b82f6;color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:500;cursor:pointer;">ç”Ÿæˆå…‘æ¢ç </button>
        </div>
        <div id="genResult" style="margin-top:12px;"></div>
      </div>
      <div style="padding:0 16px 16px;border-top:1px solid #e5e7eb;margin-top:8px;padding-top:12px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
          <h3 style="font-size:14px;font-weight:600;">å…‘æ¢ç åˆ—è¡¨</h3>
          <button onclick="fetchCoupons()" style="padding:4px 10px;border:1px solid #e0e3e8;border-radius:6px;font-size:11px;cursor:pointer;background:#fff;">åˆ·æ–°</button>
        </div>
        <div id="couponList" style="max-height:calc(100vh - 420px);overflow-y:auto;">
          <div style="text-align:center;color:#999;font-size:13px;padding:20px;">ç‚¹å‡»ã€Œåˆ·æ–°ã€åŠ è½½</div>
        </div>
      </div>
    </div>
    <!-- è®¾ç½®æ ‡ç­¾å†…å®¹ -->
    <div id="tabSettings" class="hidden">
      <div style="padding:16px;display:flex;flex-direction:column;gap:16px;">
        <h3 style="font-size:14px;font-weight:600;">å…è´¹è¯•ç”¨è®¾ç½®</h3>
        <div>
          <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">è¯•ç”¨æœŸå¤©æ•°</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input id="settingTrialDays" type="number" value="30" min="1" max="365" style="padding:8px 12px;border:1px solid #e0e3e8;border-radius:8px;font-size:13px;outline:none;width:80px;" />
            <span style="font-size:12px;color:#999;">å¤©ï¼ˆé¦–æ¬¡ä½¿ç”¨èµ·ç®—ï¼‰</span>
          </div>
        </div>
        <div>
          <label style="font-size:12px;color:#666;display:block;margin-bottom:4px;">æ¯æ—¥å…è´¹æ¬¡æ•°</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input id="settingDailyLimit" type="number" value="5" min="1" max="100" style="padding:8px 12px;border:1px solid #e0e3e8;border-radius:8px;font-size:13px;outline:none;width:80px;" />
            <span style="font-size:12px;color:#999;">æ¬¡/å¤©</span>
          </div>
        </div>
        <button onclick="saveSettings()" style="padding:10px 20px;background:#3b82f6;color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:500;cursor:pointer;width:fit-content;">ä¿å­˜è®¾ç½®</button>
        <div id="settingsResult"></div>
        <div style="margin-top:8px;padding:12px;background:#f9fafb;border-radius:8px;font-size:11px;color:#999;line-height:1.8;">
          <strong>è¯´æ˜ï¼š</strong><br/>
          Â· è¯•ç”¨æœŸå¤©æ•°ï¼šç”¨æˆ·é¦–æ¬¡ä½¿ç”¨åå¯å…è´¹ä½¿ç”¨çš„å¤©æ•°ï¼Œåˆ°æœŸåéœ€å…‘æ¢æˆ–è´­ä¹°<br/>
          Â· æ¯æ—¥å…è´¹æ¬¡æ•°ï¼šè¯•ç”¨æœŸå†…æ¯å¤©å¯å…è´¹å¯¹è¯çš„æ¬¡æ•°<br/>
          Â· ä¿®æ”¹åç«‹å³å¯¹æ‰€æœ‰å…è´¹ç”¨æˆ·ç”Ÿæ•ˆ
        </div>
      </div>
    </div>
  </div>

  <!-- å³ä¾§ï¼šå›ºå®šç»“æ„ï¼Œä¸ä¼šè¢«é‡å»º -->
  <div class="chat-area" id="mainChat">
    <!-- æ— é€‰ä¸­çŠ¶æ€ -->
    <div class="no-chat" id="noChat">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
      <p>é€‰æ‹©ä¸€ä¸ªä¼šè¯å¼€å§‹å›å¤</p>
    </div>

    <!-- èŠå¤©å†…å®¹ï¼ˆé€‰ä¸­åæ˜¾ç¤ºï¼‰ -->
    <div class="chat-header hidden" id="chatHeader">
      <h2 id="chatTitle">-</h2>
      <p id="chatSubtitle">-</p>
    </div>
    <div class="chat-messages hidden" id="chatMessages"></div>
    <div class="chat-input-area hidden" id="chatInputArea">
      <div class="preview-area" id="previewArea"></div>
      <div class="input-toolbar">
        <button onclick="document.getElementById('fileInput').click()">ğŸ“ ä¸Šä¼ æ–‡ä»¶</button>
        <button onclick="document.getElementById('imageInput').click()">ğŸ–¼ï¸ ä¸Šä¼ å›¾ç‰‡</button>
        <span style="font-size:11px;color:#bbb;margin-left:auto;">æ”¯æŒç²˜è´´å›¾ç‰‡ (Ctrl+V)</span>
      </div>
      <div class="input-row">
        <textarea id="replyInput" placeholder="è¾“å…¥å›å¤..." rows="1"></textarea>
        <button class="send-btn" onclick="sendReply()" id="sendBtn">å‘é€</button>
      </div>
      <input type="file" id="fileInput" accept="*/*" multiple style="display:none" />
      <input type="file" id="imageInput" accept="image/*" multiple style="display:none" />
    </div>
  </div>

  <!-- å³ä¾§ï¼šå…‘æ¢ç è¯¦æƒ…åŒº -->
  <div class="chat-area hidden" id="mainCoupon" style="padding:40px;overflow-y:auto;">
    <div id="couponDetail" style="max-width:600px;margin:0 auto;">
      <div class="no-chat">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:64px;height:64px;opacity:0.3;"><path d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/></svg>
        <p style="font-size:15px;color:#ccc;">åœ¨å·¦ä¾§ç”Ÿæˆæˆ–ç®¡ç†å…‘æ¢ç </p>
      </div>
    </div>
  </div>

  <!-- å›¾ç‰‡å¤§å›¾æŸ¥çœ‹ -->
  <div class="lightbox hidden" id="lightbox" onclick="this.classList.add('hidden')">
    <img id="lightboxImg" src="" />
  </div>

  <script>
    let currentUserId = null;
    let threads = [];
    let pendingFiles = []; // { name, type, dataUrl }
    let lastMsgCount = 0;

    // === ä¼šè¯åˆ—è¡¨ ===
    async function fetchThreads() {
      try {
        const resp = await fetch('/api/threads');
        const data = await resp.json();
        threads = data.threads || [];
        renderThreads();

        if (currentUserId) {
          const thread = threads.find(t => t.userId === currentUserId);
          if (thread) {
            const newCount = thread.messages.length;
            if (newCount !== lastMsgCount) {
              renderMessages(thread.messages);
              lastMsgCount = newCount;
            }
            document.getElementById('chatSubtitle').textContent =
              `${thread.messages.length} æ¡æ¶ˆæ¯ Â· æœ€åæ´»åŠ¨ ${formatTime(thread.lastActivity)}`;
          }
        }
      } catch (err) {
        console.error('è·å–ä¼šè¯å¤±è´¥:', err);
      }
    }

    function renderThreads() {
      const list = document.getElementById('threadList');
      if (threads.length === 0) {
        list.innerHTML = '<div class="thread-empty">æš‚æ— ä¼šè¯</div>';
        return;
      }
      let totalUnread = 0;
      let html = '';
      for (const t of threads) {
        const lastMsg = t.messages[t.messages.length - 1];
        let preview = 'æš‚æ— æ¶ˆæ¯';
        if (lastMsg) {
          const prefix = lastMsg.from === 'admin' ? '[å®¢æœ] ' : '';
          preview = lastMsg.content.startsWith('data:image') ? prefix + '[å›¾ç‰‡]' : prefix + lastMsg.content.slice(0, 30);
        }
        const time = lastMsg ? formatTime(lastMsg.timestamp) : '';
        const isActive = t.userId === currentUserId;
        totalUnread += t.unread || 0;
        html += `
          <div class="thread-item ${isActive ? 'active' : ''}" onclick="selectThread('${t.userId}')">
            <div class="thread-avatar">ğŸ‘¤</div>
            <div class="thread-info">
              <div class="thread-name">
                ${t.userId.slice(0, 8)}...
                ${t.unread > 0 ? '<span class="unread-badge">' + t.unread + '</span>' : ''}
              </div>
              <div class="thread-preview">${escapeHtml(preview)}</div>
            </div>
            <div class="thread-time">${time}</div>
          </div>`;
      }
      list.innerHTML = html;
      document.getElementById('totalUnread').textContent = totalUnread > 0 ? totalUnread + ' æ¡æœªè¯»' : '';
    }

    // === é€‰ä¸­ä¼šè¯ ===
    async function selectThread(userId) {
      currentUserId = userId;
      lastMsgCount = 0;

      // æ˜¾ç¤ºèŠå¤©åŒºï¼Œéšè—ç©ºçŠ¶æ€
      document.getElementById('noChat').classList.add('hidden');
      document.getElementById('chatHeader').classList.remove('hidden');
      document.getElementById('chatMessages').classList.remove('hidden');
      document.getElementById('chatInputArea').classList.remove('hidden');

      document.getElementById('chatTitle').textContent = 'ç”¨æˆ· ' + userId.slice(0, 8) + '...';

      const thread = threads.find(t => t.userId === userId);
      if (thread) {
        renderMessages(thread.messages);
        lastMsgCount = thread.messages.length;
        document.getElementById('chatSubtitle').textContent =
          `${thread.messages.length} æ¡æ¶ˆæ¯ Â· æœ€åæ´»åŠ¨ ${formatTime(thread.lastActivity)}`;
        if (thread.unread > 0) {
          fetch('/api/mark-read', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId }),
          }).then(() => fetchThreads());
        }
      }
      renderThreads();

      // èšç„¦è¾“å…¥æ¡†
      setTimeout(() => document.getElementById('replyInput')?.focus(), 100);
    }

    // === åªæ›´æ–°æ¶ˆæ¯åˆ—è¡¨ï¼ˆä¸ç¢°è¾“å…¥æ¡†ï¼‰===
    function renderMessages(messages) {
      const container = document.getElementById('chatMessages');
      let html = '';
      for (const msg of messages) {
        const isAdmin = msg.from === 'admin';
        const contentHtml = renderContent(msg.content);
        html += `
          <div class="msg-row ${isAdmin ? 'admin' : 'user'}">
            <div>
              <div class="msg-bubble">${contentHtml}</div>
              <div class="msg-time">${isAdmin ? 'å®¢æœ' : 'ç”¨æˆ·'} Â· ${new Date(msg.timestamp).toLocaleString('zh-CN')}</div>
            </div>
          </div>`;
      }
      container.innerHTML = html || '<div style="text-align:center;color:#ccc;padding:40px;">æš‚æ— æ¶ˆæ¯</div>';
      container.scrollTop = container.scrollHeight;
    }

    // æ¸²æŸ“æ¶ˆæ¯å†…å®¹ï¼ˆæ”¯æŒå›¾ç‰‡ï¼‰
    function renderContent(content) {
      if (content.startsWith('data:image')) {
        return '<img src="' + content + '" onclick="showLightbox(this.src)" />';
      }
      return escapeHtml(content);
    }

    // å¤§å›¾é¢„è§ˆ
    function showLightbox(src) {
      document.getElementById('lightboxImg').src = src;
      document.getElementById('lightbox').classList.remove('hidden');
    }

    // === å‘é€å›å¤ ===
    async function sendReply() {
      const input = document.getElementById('replyInput');
      const btn = document.getElementById('sendBtn');
      const text = input.value.trim();

      // å‘é€æ–‡ä»¶
      if (pendingFiles.length > 0) {
        btn.disabled = true;
        btn.textContent = 'å‘é€ä¸­...';
        for (const file of pendingFiles) {
          await doSend(file.dataUrl);
        }
        pendingFiles = [];
        document.getElementById('previewArea').innerHTML = '';
        // å¦‚æœè¿˜æœ‰æ–‡å­—ä¹Ÿä¸€èµ·å‘
        if (text) {
          await doSend(text);
          input.value = '';
          autoResizeTextarea(input);
        }
        btn.disabled = false;
        btn.textContent = 'å‘é€';
        input.focus();
        return;
      }

      if (!text) return;
      btn.disabled = true;
      btn.textContent = 'å‘é€ä¸­...';
      await doSend(text);
      input.value = '';
      autoResizeTextarea(input);
      btn.disabled = false;
      btn.textContent = 'å‘é€';
      input.focus();
    }

    async function doSend(message) {
      if (!currentUserId || !message) return;
      try {
        const resp = await fetch('/api/reply', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: currentUserId, message }),
        });
        if (resp.ok) {
          await fetchThreads();
        } else {
          const data = await resp.json().catch(() => ({ error: resp.statusText }));
          alert('å‘é€å¤±è´¥ (' + resp.status + '): ' + (data.error || JSON.stringify(data) || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (err) {
        console.error('å‘é€é”™è¯¯:', err);
        alert('å‘é€å¤±è´¥: ' + err.message + '\n\nè¯·æ£€æŸ¥:\n1. åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ\n2. Redis è¿æ¥æ˜¯å¦æ­£å¸¸\n3. Vercel ç¯å¢ƒå˜é‡æ˜¯å¦é…ç½®');
      }
    }

    // === æ–‡ä»¶/å›¾ç‰‡å¤„ç† ===
    function handleFiles(files) {
      for (const file of files) {
        if (file.size > 500 * 1024) {
          alert(`æ–‡ä»¶ "${file.name}" å¤ªå¤§ï¼ˆ${(file.size/1024/1024).toFixed(1)}MBï¼‰ï¼Œæœ€å¤§æ”¯æŒ 500KB`);
          continue;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          pendingFiles.push({ name: file.name, type: file.type, dataUrl: e.target.result });
          renderPreviews();
        };
        reader.readAsDataURL(file);
      }
    }

    function renderPreviews() {
      const area = document.getElementById('previewArea');
      let html = '';
      pendingFiles.forEach((f, i) => {
        if (f.type.startsWith('image/')) {
          html += `<div class="preview-item">
            <img src="${f.dataUrl}" />
            <button class="remove-btn" onclick="removeFile(${i})">Ã—</button>
          </div>`;
        } else {
          html += `<div class="preview-item" style="padding:8px 12px;background:#f3f4f6;border-radius:8px;font-size:12px;display:flex;align-items:center;gap:6px;">
            ğŸ“„ ${escapeHtml(f.name)}
            <button class="remove-btn" style="position:static;margin-left:4px;" onclick="removeFile(${i})">Ã—</button>
          </div>`;
        }
      });
      area.innerHTML = html;
    }

    function removeFile(index) {
      pendingFiles.splice(index, 1);
      renderPreviews();
    }

    // === äº‹ä»¶ç»‘å®š ===
    // æ–‡ä»¶ä¸Šä¼ 
    document.getElementById('fileInput').addEventListener('change', (e) => {
      handleFiles(e.target.files);
      e.target.value = '';
    });
    document.getElementById('imageInput').addEventListener('change', (e) => {
      handleFiles(e.target.files);
      e.target.value = '';
    });

    // ç²˜è´´å›¾ç‰‡
    document.getElementById('replyInput').addEventListener('paste', (e) => {
      const items = e.clipboardData?.items;
      if (!items) return;
      for (const item of items) {
        if (item.type.startsWith('image/')) {
          e.preventDefault();
          const file = item.getAsFile();
          if (file) handleFiles([file]);
        }
      }
    });

    // Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
    document.getElementById('replyInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendReply();
      }
    });

    // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
    document.getElementById('replyInput').addEventListener('input', function() {
      autoResizeTextarea(this);
    });

    function autoResizeTextarea(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 120) + 'px';
    }

    // === å·¥å…·å‡½æ•° ===
    function formatTime(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      const now = new Date();
      const diff = now - d;
      if (diff < 60000) return 'åˆšåˆš';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
      if (diff < 86400000) return d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      return d.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // === æ ‡ç­¾é¡µåˆ‡æ¢ ===
    let currentTab = 'chat';
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');

      document.getElementById('tabChat').classList.toggle('hidden', tab !== 'chat');
      document.getElementById('tabCoupon').classList.toggle('hidden', tab !== 'coupon');
      document.getElementById('tabSettings').classList.toggle('hidden', tab !== 'settings');
      document.getElementById('mainChat').classList.toggle('hidden', tab !== 'chat');
      document.getElementById('mainCoupon').classList.toggle('hidden', tab !== 'coupon');

      if (tab === 'coupon') fetchCoupons();
      if (tab === 'settings') loadSettings();
    }

    // === ç³»ç»Ÿè®¾ç½® ===
    async function loadSettings() {
      try {
        const resp = await fetch('/api/settings');
        const data = await resp.json();
        const s = data.settings;
        document.getElementById('settingTrialDays').value = s.freeTrialDays || 30;
        document.getElementById('settingDailyLimit').value = s.freeDailyLimit || 5;
      } catch (err) {
        console.error('åŠ è½½è®¾ç½®å¤±è´¥:', err);
      }
    }

    async function saveSettings() {
      const resultDiv = document.getElementById('settingsResult');
      const freeTrialDays = parseInt(document.getElementById('settingTrialDays').value) || 30;
      const freeDailyLimit = parseInt(document.getElementById('settingDailyLimit').value) || 5;

      try {
        const resp = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ freeTrialDays, freeDailyLimit }),
        });
        const data = await resp.json();
        if (data.success) {
          resultDiv.innerHTML = '<span style="color:#16a34a;font-size:12px;">âœ… è®¾ç½®å·²ä¿å­˜</span>';
          setTimeout(() => { resultDiv.innerHTML = ''; }, 3000);
        } else {
          resultDiv.innerHTML = `<span style="color:#dc2626;font-size:12px;">âŒ ${data.error}</span>`;
        }
      } catch (err) {
        resultDiv.innerHTML = `<span style="color:#dc2626;font-size:12px;">âŒ ${err.message}</span>`;
      }
    }

    // === å…‘æ¢ç ç®¡ç† ===
    async function generateCoupons() {
      const plan = document.getElementById('couponPlan').value;
      const count = parseInt(document.getElementById('couponCount').value) || 5;
      const resultDiv = document.getElementById('genResult');
      resultDiv.innerHTML = '<span style="color:#999;font-size:12px;">ç”Ÿæˆä¸­...</span>';

      try {
        const resp = await fetch('/api/coupons/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ plan, count }),
        });
        const data = await resp.json();
        if (data.success) {
          let html = `<div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:10px;font-size:12px;">
            <strong style="color:#16a34a;">âœ… æˆåŠŸç”Ÿæˆ ${data.codes.length} ä¸ªå…‘æ¢ç </strong>
            <div style="margin-top:8px;font-family:Courier New,monospace;font-size:13px;line-height:2;user-select:all;">`;
          for (const code of data.codes) {
            html += `<div>${code}</div>`;
          }
          html += `</div>
            <button onclick="copyAllCodes(this)" style="margin-top:8px;padding:6px 14px;background:#3b82f6;color:#fff;border:none;border-radius:6px;font-size:12px;cursor:pointer;">ğŸ“‹ å¤åˆ¶å…¨éƒ¨</button>
          </div>`;
          resultDiv.innerHTML = html;
          resultDiv._codes = data.codes;
          fetchCoupons();
        } else {
          resultDiv.innerHTML = `<span style="color:#dc2626;font-size:12px;">âŒ ${data.error}</span>`;
        }
      } catch (err) {
        resultDiv.innerHTML = `<span style="color:#dc2626;font-size:12px;">âŒ ${err.message}</span>`;
      }
    }

    function copyAllCodes(btn) {
      const codes = document.getElementById('genResult')._codes;
      if (codes) {
        navigator.clipboard.writeText(codes.join('\n')).then(() => {
          btn.textContent = 'âœ… å·²å¤åˆ¶';
          setTimeout(() => { btn.textContent = 'ğŸ“‹ å¤åˆ¶å…¨éƒ¨'; }, 2000);
        });
      }
    }

    function copySingleCode(code, btn) {
      navigator.clipboard.writeText(code).then(() => {
        btn.textContent = 'å·²å¤åˆ¶';
        setTimeout(() => { btn.textContent = 'å¤åˆ¶'; }, 1500);
      });
    }

    async function fetchCoupons() {
      const listDiv = document.getElementById('couponList');
      listDiv.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;padding:12px;">åŠ è½½ä¸­...</div>';

      try {
        const resp = await fetch('/api/coupons');
        const data = await resp.json();
        const coupons = data.coupons || [];

        if (coupons.length === 0) {
          listDiv.innerHTML = '<div style="text-align:center;color:#999;font-size:13px;padding:20px;">æš‚æ— å…‘æ¢ç </div>';
          return;
        }

        let html = '';
        for (const c of coupons) {
          const statusBadge = c.usedBy
            ? '<span class="badge used">å·²ä½¿ç”¨</span>'
            : '<span class="badge unused">æœªä½¿ç”¨</span>';
          const planBadge = `<span class="badge ${c.plan}">${c.planLabel}</span>`;
          const time = new Date(c.createdAt).toLocaleDateString('zh-CN');
          const usedInfo = c.usedBy ? `<span>Â· è¢« ${c.usedBy.slice(0,10)}... ä½¿ç”¨</span>` : '';

          html += `<div class="coupon-item">
            <div style="display:flex;align-items:center;justify-content:space-between;">
              <span class="code">${c.code}</span>
              <button class="copy-btn" onclick="copySingleCode('${c.code}', this)">å¤åˆ¶</button>
            </div>
            <div class="meta">
              ${planBadge} ${statusBadge}
              <span>${time}</span>
              ${usedInfo}
            </div>
          </div>`;
        }
        listDiv.innerHTML = html;
      } catch (err) {
        listDiv.innerHTML = `<div style="color:#dc2626;font-size:12px;padding:12px;">åŠ è½½å¤±è´¥: ${err.message}</div>`;
      }
    }

    // === å¯åŠ¨ ===
    fetchThreads();
    setInterval(fetchThreads, 3000);
  </script>
</body>
</html>
